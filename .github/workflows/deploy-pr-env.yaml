name: Deploy Static Site

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Version of site to deploy (ex: react-frontend/main/0.0.1)'
        required: true
        type: string
        
      workspace:
        description: '(ex: pr-<branch-name> , dev, qa, prod)'
        required: true
        type: string
  
  workflow_call:
    inputs:
      release_version:
        description: 'Version of site to deploy (ex: react-frontend/main/0.0.1)'
        required: true
        type: string
        
      workspace:
        description: '(ex: pr-<branch-name> , dev, qa, prod)'
        required: true
        type: string

    outputs:
      pr-url:
        description: "The deployed environment URL"
        value: ${{ jobs.deploy.outputs.url }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs: 
      url: ${{ steps.bucket_url.outputs.website_url }}

    steps:
      - uses: actions/checkout@v4

      - name: Get S3 Bucket Name
        id: get_bucket_name
        shell: bash
        run : |
            BUCKET_NAME=$(echo "${{ vars.APP_NAME }}-${{ inputs.workspace }}" | sed 's|[/\.]|-|g' )
            echo "name=$BUCKET_NAME" >> $GITHUB_OUTPUT

      - name: Apply S3 Infrastructure
        id: terraform_apply
        uses: ./.github/actions/terraform-apply
        with:
          aws-access-key: ${{ secrets.AWSACCESSKEYID }}
          aws-secret-key: ${{ secrets.AWSSECRETACCESSKEY }}
          aws-region: ${{ vars.AWS_REGION }}
          terraform-state-bucket-name: ${{ vars.TERRAFORMSTATEBUCKETNAME }}
          terraform-files-directory: './IAC/terraform'
          terraform-workspace-name: ${{ inputs.workspace }}
          # Pass the variables as a strict JSON string
          terraform-variable-values-map: '{"aws_region": "${{ vars.AWS_REGION }}", "bucket_name": "${{ steps.get_bucket_name.outputs.name }}"}'

      - name: Log Terraform JSON
        id: bucket_url
        shell: bash
        run: |
          echo TERRAFORM OUTPUTS ${{steps.terraform_apply.outputs.terraform-outputs}}
          echo TERRAFORM JSON ${{ fromJson(steps.terraform_apply.outputs.terraform-outputs) }}
          echo BUCKET NAME ${{ fromJson(steps.terraform_apply.outputs.terraform-outputs).bucket_name.value }}
          echo WEBSITE URL ${{ fromJson(steps.terraform_apply.outputs.terraform-outputs).website_url.value }}

          echo "bucket_name=${{ fromJson(steps.terraform_apply.outputs.terraform-outputs).bucket_name.value }}" >> $GITHUB_OUTPUT
          echo "website_url=${{ fromJson(steps.terraform_apply.outputs.terraform-outputs).website_url.value }}" >> $GITHUB_OUTPUT

      - name: Publish PR Site
        id: publish_pr_site
        uses: ./.github/actions/publish-to-s3
        with:
          artifacts-path: s3://${{ vars.BUILDARTIFACTSBUCKETNAME }}/${{ inputs.release_version }}
          s3-bucket: ${{ fromJson(steps.terraform_apply.outputs.terraform-outputs).bucket_name.value }}
          aws-region: ${{ vars.AWS_REGION }}
          aws-access-key: ${{ secrets.AWSACCESSKEYID }}
          aws-secret-key: ${{ secrets.AWSSECRETACCESSKEY }}